<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>KVC &amp; KVO | kakadee</title>
    <meta name="description" content="种一棵树最好的时间是十年前，其次就是现在。">
    
    
    <link rel="preload" href="/kakadeeBlog/assets/css/0.styles.5f1205b4.css" as="style"><link rel="preload" href="/kakadeeBlog/assets/js/app.8bc012c0.js" as="script"><link rel="preload" href="/kakadeeBlog/assets/js/2.312bb894.js" as="script"><link rel="preload" href="/kakadeeBlog/assets/js/15.360c988d.js" as="script"><link rel="prefetch" href="/kakadeeBlog/assets/js/10.ff4e560c.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/11.5e7d1227.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/12.8737b8e5.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/13.3fa76b06.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/14.3d8eb73c.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/16.215897df.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/17.5b1c033f.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/18.6dd2fa4f.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/19.18c4a796.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/3.119f8bcd.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/4.f7c0e7b7.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/5.4aebb849.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/6.f4cc0c84.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/7.b00e30c5.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/8.a94648fe.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/9.a6206a54.js">
    <link rel="stylesheet" href="/kakadeeBlog/assets/css/0.styles.5f1205b4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/kakadeeBlog/" class="home-link router-link-active"><!----> <span class="site-name">kakadee</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/kakadeeBlog/iOS/" class="nav-link router-link-active">iOS</a></div><div class="nav-item"><a href="/kakadeeBlog/Project/" class="nav-link">Project</a></div><div class="nav-item"><a href="/kakadeeBlog/Resume/" class="nav-link">Resume</a></div><div class="nav-item"><a href="/kakadeeBlog/Essay/" class="nav-link">Essay</a></div> <a href="https://github.com/kakadee/kakadeeBlog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/kakadeeBlog/iOS/" class="nav-link router-link-active">iOS</a></div><div class="nav-item"><a href="/kakadeeBlog/Project/" class="nav-link">Project</a></div><div class="nav-item"><a href="/kakadeeBlog/Resume/" class="nav-link">Resume</a></div><div class="nav-item"><a href="/kakadeeBlog/Essay/" class="nav-link">Essay</a></div> <a href="https://github.com/kakadee/kakadeeBlog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/kakadeeBlog/iOS/" class="sidebar-link">iOS</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>iOS基础</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kakadeeBlog/iOS/iOSBasic/Block详解.html" class="sidebar-link">Block 详解</a></li><li><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html" class="active sidebar-link">KVC &amp; KVO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html#kvc" class="sidebar-link">KVC</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html#kvc属性" class="sidebar-link">KVC属性</a></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html#如何使用kvc" class="sidebar-link">如何使用KVC</a></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html#实现的细节" class="sidebar-link">实现的细节</a></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html#总结" class="sidebar-link">总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html#kvo" class="sidebar-link">KVO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html#如何使用kvo" class="sidebar-link">如何使用KVO</a></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html#kvo实现原理" class="sidebar-link">KVO实现原理</a></li></ul></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html#面试题" class="sidebar-link">面试题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html#_1-ios用什么方式实现对一个对象的kvo？（kvo的本质是什么？）" class="sidebar-link">1. iOS用什么方式实现对一个对象的KVO？（KVO的本质是什么？）</a></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html#_2-如何手动触发kvo" class="sidebar-link">2. 如何手动触发KVO</a></li></ul></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/kakadeeBlog/iOS/iOSBasic/DesignatedInitializer.html" class="sidebar-link">Designated initializer</a></li><li><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html" class="sidebar-link">Category本质</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Core Animation</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="kvc-kvo"><a href="#kvc-kvo" aria-hidden="true" class="header-anchor">#</a> KVC &amp; KVO</h1> <h2 id="kvc"><a href="#kvc" aria-hidden="true" class="header-anchor">#</a> KVC</h2> <ol><li>KVC 中文名叫 键值编码，是 Key-Value-Coding 的简称。</li> <li>KVC 是一种可以直接通过字符串的名字 key 来访问类属性的机制，而不是通过调用 setter、getter 方法去访问。</li> <li>我们可以通过在运行时动态的访问和修改对象的属性。而不是在编译时确定，KVC 是 iOS 开发中的黑魔法之一。</li></ol> <h3 id="kvc属性"><a href="#kvc属性" aria-hidden="true" class="header-anchor">#</a> KVC属性</h3> <p>KVC 是通过字符串的 key 来访问和设置类属性的。</p> <ul><li>设置值</li></ul> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token comment">// value的值为OC对象，如果是基本数据类型要包装成NSNumber</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setValue<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>value forKey<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>key<span class="token punctuation">;</span>

<span class="token comment">// keyPath键路径，类型为xx.xx</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setValue<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>value forKeyPath<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>keyPath<span class="token punctuation">;</span>

<span class="token comment">// 它的默认实现是抛出异常，可以重写这个函数做错误处理。</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setValue<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>value forUndefinedKey<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>key<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>获取值</li></ul> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>valueForKey<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>key<span class="token punctuation">;</span>

<span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>valueForKeyPath<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>keyPath<span class="token punctuation">;</span>

<span class="token comment">// 如果Key不存在，且没有KVC无法搜索到任何和Key有关的字段或者属性，则会调用这个方法，默认是抛出异常</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>valueForUndefinedKey<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>key<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>NSKeyValueCoding 类别中还有其他的一些方法:</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token comment">// 允许直接访问实例变量，默认返回YES。如果某个类重写了这个方法，且返回NO，则KVC不可以访问该类。</span>
<span class="token operator">+</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>accessInstanceVariablesDirectly<span class="token punctuation">;</span>

<span class="token comment">// 这是集合操作的API，里面还有一系列这样的API，如果属性是一个NSMutableArray，那么可以用这个方法来返回</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>NSMutableArray <span class="token operator">*</span><span class="token punctuation">)</span>mutableArrayValueForKey<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>key<span class="token punctuation">;</span>

<span class="token comment">// 如果你在setValue方法时面给Value传nil，则会调用这个方法</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setNilValueForKey<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>key<span class="token punctuation">;</span>

<span class="token comment">// 输入一组key，返回该组key对应的Value，再转成字典返回，用于将Model转到字典。</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>NSDictionary <span class="token operator">*</span><span class="token punctuation">)</span>dictionaryWithValuesForKeys<span class="token punctuation">:</span><span class="token punctuation">(</span>NSArray <span class="token operator">*</span><span class="token punctuation">)</span>keys<span class="token punctuation">;</span>

<span class="token comment">// KVC提供属性值确认的API，它可以用来检查set的值是否正确、为不正确的值做一个替换值或者拒绝设置新值并返回错误原因。</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>validateValue<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>ioValue forKey<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>inKey error<span class="token punctuation">:</span><span class="token punctuation">(</span>NSError<span class="token punctuation">)</span>outError<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="如何使用kvc"><a href="#如何使用kvc" aria-hidden="true" class="header-anchor">#</a> 如何使用KVC</h3> <p>定义一个Person类。</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token comment">//  Person.h</span>
<span class="token keyword">@interface</span> Person <span class="token punctuation">:</span> NSObject
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> copy<span class="token punctuation">,</span> readonly<span class="token punctuation">)</span> NSString <span class="token operator">*</span>name<span class="token punctuation">;</span>
<span class="token keyword">@end</span>

<span class="token comment">//  Person.m</span>
<span class="token keyword">@interface</span> Person <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">@property</span> <span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> copy<span class="token punctuation">,</span> readwrite<span class="token punctuation">)</span> NSString <span class="token operator">*</span>name<span class="token punctuation">;</span>
<span class="token keyword">@end</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>设置私有变量 age 和 只读变量 name, 如果用一般的 setter 和 getter，在类外部是不能访问到私有变量的，不能设值给只读变量，那是不是就拿它没办法了呢? 然而 KVC 可以做到，就是这么神奇。</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token punctuation">[</span>p setValue<span class="token punctuation">:</span><span class="token string">@&quot;Jack&quot;</span> forKey<span class="token punctuation">:</span><span class="token string">@&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>p setValue<span class="token punctuation">:</span><span class="token punctuation">[</span>NSNumber numberWithInteger<span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">]</span> forKey<span class="token punctuation">:</span><span class="token string">@&quot;age&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;test---p.name:%@,age:%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>p valueForKey<span class="token punctuation">:</span><span class="token string">@&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span>p valueForKey<span class="token punctuation">:</span><span class="token string">@&quot;isAge&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="实现的细节"><a href="#实现的细节" aria-hidden="true" class="header-anchor">#</a> 实现的细节</h3> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setValue<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>value forKey<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>key<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>参考Search Pattern for the Basic Setter [1]</p> <ol><li>首先搜索 setter 方法(set&lt;Key&gt;: or _set&lt;Key&gt;)，有就直接赋值。</li> <li>如果上面的 setter 方法没有找到，再检查类方法+ (BOOL)accessInstanceVariablesDirectly
<ol><li>返回 NO，则执行setValue：forUNdefinedKey：</li> <li>返回 YES，则按_&lt;key&gt;，_&lt;isKey&gt;，&lt;key&gt;，&lt;isKey&gt;的顺序搜索成员名。</li></ol></li> <li>还没有找到的话，就调用setValue:forUndefinedKey;</li> <li>如果没有重写 setValue:forUndefinedKey，会造成崩溃(抛出NSUndefinedKeyException)。</li></ol> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>valueForKey<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>key<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol><li>首先查找 getter (get&lt;Key&gt;, &lt;key&gt;, is&lt;Key&gt;, or _&lt;key&gt; )方法，找到直接调用。如果是 bool、int、float 等基本数据类型，会做 NSNumber 的转换。</li> <li>如果没查到，再检查类方法+ (BOOL)accessInstanceVariablesDirectly
<ol><li>返回 NO，则执行valueForUNdefinedKey:</li> <li>返回 YES，则按_&lt;key&gt;,_is&lt;Key&gt;,&lt;key&gt;,is&lt;Key&gt;的顺序搜索成员名。</li></ol></li> <li>还没有找到的话，调用valueForUndefinedKey;</li> <li>如果没有重写 valueForUndefinedKey，也会造成崩溃(抛出NSUndefinedKeyException)。</li></ol> <h3 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h3> <p><strong>KVC 与点语法比较</strong>
用 KVC 访问属性和用点语法访问属性的区别：</p> <ol><li>用点语法编译器会做预编译检查，访问不存在的属性编译器会报错，但是用 KVC 方式编译器无法做检查，如果有错误只能运行的时候才能发现（crash）。</li> <li>相比点语法用 KVC 方式 KVC 的效率会稍低一点，但是灵活，可以在程序运行时决定访问哪些属性。</li> <li>用 KVC 可以访问对象的私有成员变量。</li></ol> <p><strong>优点：</strong></p> <ol><li>不需要通过 setter、getter 方法去访问对象的属性，可以访问对象的私有属性</li> <li>可以轻松处理集合类。</li></ol> <p><strong>缺点：</strong></p> <ol><li>一旦使用KVC你的编译器无法检查出错误，即不会对设置的键、键值路径进行错误检查。</li> <li>执行效率要低于 setter 和 getter 方法。因为使用 KVC 键值编码，它必须先解析字符串，然后在设置或者访问对象的实例变量。</li> <li>使用 KVC 会破坏类的封装性。</li></ol> <h2 id="kvo"><a href="#kvo" aria-hidden="true" class="header-anchor">#</a> KVO</h2> <ol><li>KVO 是 Key-Value-Observing 的简称。</li> <li>KVO 是一个观察者模式。观察一个对象的属性，注册一个指定的路径，若这个对象的的属性被修改，则 KVO 会自动通知观察者。</li> <li>更通俗的话来说就是任何对象都允许观察其他对象的属性，并且可以接收其他对象状态变化的通知。</li></ol> <h3 id="如何使用kvo"><a href="#如何使用kvo" aria-hidden="true" class="header-anchor">#</a> 如何使用KVO</h3> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token number">1.</span><span class="token comment">// 注册观察者，实施监听；</span>
<span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>person addObserver<span class="token punctuation">:</span><span class="token keyword">self</span>
              forKeyPath<span class="token punctuation">:</span><span class="token string">@&quot;age&quot;</span>
                 options<span class="token punctuation">:</span>NSKeyValueObservingOptionNew
                 context<span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">2.</span><span class="token comment">// 回调方法，在这里处理属性发生的变化；</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>observeValueForKeyPath<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>keyPath
                      ofObject<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>object
                        change<span class="token punctuation">:</span><span class="token punctuation">(</span>NSDictionary<span class="token operator">&lt;</span>NSString <span class="token operator">*</span><span class="token punctuation">,</span>id<span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token punctuation">)</span>change
                       context<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>context

<span class="token number">3.</span><span class="token comment">// 移除观察者；</span>
<span class="token punctuation">[</span><span class="token keyword">self</span> removeObserver<span class="token punctuation">:</span><span class="token keyword">self</span> forKeyPath<span class="token punctuation">:</span><span class="token operator">@</span>“age&quot;<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="kvo实现原理"><a href="#kvo实现原理" aria-hidden="true" class="header-anchor">#</a> KVO实现原理</h3> <p>当某个类的对象第一次被观察时，系统就会在运行期动态地创建该类的一个派生类，在这个派生类中重写基类中任何被观察属性的 setter 方法。 派生类在被重写的 setter 方法实现真正的通知机制，就如前面手动实现键值观察那样。这么做是基于设置属性会调用 setter 方法，而通过重写就获得了 KVO 需要的通知机制。</p> <p>当然前提是要通过遵循 KVO 的属性设置方式来变更属性值，如果仅是直接修改属性对应的成员变量，是无法实现 KVO 的。 同时派生类还重写了 class 方法以“欺骗”外部调用者它就是起初的那个类。然后系统将这个对象的 isa 指针指向这个新诞生的派生类，因此这个对象就成为该派生类的对象了，因而在该对象上对 setter 的调用就会调用重写的 setter，从而激活键值通知机制。此外，派生类还重写了 dealloc 方法来释放资源。</p> <p><strong>派生类 NSKVONotifying_Person 剖析：</strong></p> <p>在这个过程，被观察对象的 isa 指针从指向原来的 Person 类，被 KVO 机制修改为指向系统新创建的子类 NSKVONotifying_Person 类，来实现当前类属性值改变的监听。</p> <p>所以当我们从应用层面上看来，完全没有意识到有新的类出现，这是系统“隐瞒”了对 KVO 的底层实现过程，让我们误以为还是原来的类。但是此时如果我们创建一个新的名为 NSKVONotifying_Person 的类()，就会发现系统运行到注册 KVO 的那段代码时程序就崩溃，因为系统在注册监听的时候动态创建了名为 NSKVONotifying_Person 的中间类，并指向这个中间类了。</p> <p>因而在该对象上对 setter 的调用就会调用已重写的 setter，从而激活键值通知机制。这也是 KVO 回调机制，为什么都俗称 KVO 技术为黑魔法的原因之一吧：内部神秘、外观简洁。</p> <p><strong>子类 setter 方法剖析：</strong></p> <p>KVO 在调用存取方法之前总是调用 willChangeValueForKey:，通知系统该 keyPath 的属性值即将变更。 当改变发生后，didChangeValueForKey: 被调用，通知系统该 keyPath 的属性值已经变更。 之后，observeValueForKey:ofObject:change:context: 也会被调用。</p> <p>重写观察属性的 setter 方法这种方式是在运行时而不是编译时实现的。 KVO 为子类的观察者属性重写调用存取方法的工作原理在代码中相当于：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setName<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>newName
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> willChangeValueForKey<span class="token punctuation">:</span><span class="token string">@&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// KVO在调用存取方法之前总调用</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> setValue<span class="token punctuation">:</span>newName forKey<span class="token punctuation">:</span><span class="token string">@&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 调用父类的存取方法</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> didChangeValueForKey<span class="token punctuation">:</span><span class="token string">@&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">// KVO在调用存取方法之后总调用</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="面试题"><a href="#面试题" aria-hidden="true" class="header-anchor">#</a> 面试题</h2> <h3 id="_1-ios用什么方式实现对一个对象的kvo？（kvo的本质是什么？）"><a href="#_1-ios用什么方式实现对一个对象的kvo？（kvo的本质是什么？）" aria-hidden="true" class="header-anchor">#</a> 1. iOS用什么方式实现对一个对象的KVO？（KVO的本质是什么？）</h3> <p>答: 当一个对象使用了KVO监听，iOS系统会修改这个对象的isa指针，改为指向一个全新的通过Runtime动态创建的子类，子类拥有自己的set方法实现，set方法实现内部会顺序调用willChangeValueForKey方法、原来的setter方法实现、didChangeValueForKey方法，而didChangeValueForKey方法内部又会调用监听器的observeValueForKeyPath:ofObject:change:context:监听方法。</p> <h3 id="_2-如何手动触发kvo"><a href="#_2-如何手动触发kvo" aria-hidden="true" class="header-anchor">#</a> 2. 如何手动触发KVO</h3> <p>答: 被监听的属性的值被修改时，就会自动触发KVO。如果想要手动触发KVO，则需要我们自己调用willChangeValueForKey和didChangeValueForKey方法即可在不改变属性值的情况下手动触发KVO，并且这两个方法缺一不可。</p> <h2 id="参考"><a href="#参考" aria-hidden="true" class="header-anchor">#</a> 参考</h2> <p>[1] <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueCoding/SearchImplementation.html#//apple_ref/doc/uid/20000955-CJBBBFFA" target="_blank" rel="noopener noreferrer">Key-Value Coding Programming Guide<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>[2] KVC 与 KVO 使用姿势和原理解析 (<a href="https://www.jianshu.com/p/4748ef75126a" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/4748ef75126a<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间: </span> <span class="time">11/12/2019, 2:55:06 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/kakadeeBlog/iOS/iOSBasic/Block详解.html" class="prev">
          Block 详解
        </a></span> <span class="next"><a href="/kakadeeBlog/iOS/iOSBasic/DesignatedInitializer.html">
          Designated initializer
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/kakadeeBlog/assets/js/app.8bc012c0.js" defer></script><script src="/kakadeeBlog/assets/js/2.312bb894.js" defer></script><script src="/kakadeeBlog/assets/js/15.360c988d.js" defer></script>
  </body>
</html>
