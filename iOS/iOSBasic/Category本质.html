<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Category本质 | kakadee</title>
    <meta name="description" content="种一棵树最好的时间是十年前，其次就是现在。">
    
    
    <link rel="preload" href="/kakadeeBlog/assets/css/0.styles.5f1205b4.css" as="style"><link rel="preload" href="/kakadeeBlog/assets/js/app.8bc012c0.js" as="script"><link rel="preload" href="/kakadeeBlog/assets/js/2.312bb894.js" as="script"><link rel="preload" href="/kakadeeBlog/assets/js/13.3fa76b06.js" as="script"><link rel="prefetch" href="/kakadeeBlog/assets/js/10.ff4e560c.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/11.5e7d1227.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/12.8737b8e5.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/14.3d8eb73c.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/15.360c988d.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/16.215897df.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/17.5b1c033f.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/18.6dd2fa4f.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/19.18c4a796.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/3.119f8bcd.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/4.f7c0e7b7.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/5.4aebb849.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/6.f4cc0c84.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/7.b00e30c5.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/8.a94648fe.js"><link rel="prefetch" href="/kakadeeBlog/assets/js/9.a6206a54.js">
    <link rel="stylesheet" href="/kakadeeBlog/assets/css/0.styles.5f1205b4.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/kakadeeBlog/" class="home-link router-link-active"><!----> <span class="site-name">kakadee</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/kakadeeBlog/iOS/" class="nav-link router-link-active">iOS</a></div><div class="nav-item"><a href="/kakadeeBlog/Project/" class="nav-link">Project</a></div><div class="nav-item"><a href="/kakadeeBlog/Resume/" class="nav-link">Resume</a></div><div class="nav-item"><a href="/kakadeeBlog/Essay/" class="nav-link">Essay</a></div> <a href="https://github.com/kakadee/kakadeeBlog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/kakadeeBlog/iOS/" class="nav-link router-link-active">iOS</a></div><div class="nav-item"><a href="/kakadeeBlog/Project/" class="nav-link">Project</a></div><div class="nav-item"><a href="/kakadeeBlog/Resume/" class="nav-link">Resume</a></div><div class="nav-item"><a href="/kakadeeBlog/Essay/" class="nav-link">Essay</a></div> <a href="https://github.com/kakadee/kakadeeBlog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/kakadeeBlog/iOS/" class="sidebar-link">iOS</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>iOS基础</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/kakadeeBlog/iOS/iOSBasic/Block详解.html" class="sidebar-link">Block 详解</a></li><li><a href="/kakadeeBlog/iOS/iOSBasic/KVCKVO详解.html" class="sidebar-link">KVC &amp; KVO</a></li><li><a href="/kakadeeBlog/iOS/iOSBasic/DesignatedInitializer.html" class="sidebar-link">Designated initializer</a></li><li><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html" class="active sidebar-link">Category本质</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#category-使用场合" class="sidebar-link">Category 使用场合</a></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#category-实现原理" class="sidebar-link">Category 实现原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#编译期" class="sidebar-link">编译期</a></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#运行期" class="sidebar-link">运行期</a></li></ul></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#category-添加成员变量" class="sidebar-link">Category 添加成员变量</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#正确认识" class="sidebar-link">正确认识</a></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#如何添加" class="sidebar-link">如何添加</a></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#关联对象的原理" class="sidebar-link">关联对象的原理</a></li></ul></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#load-initialize" class="sidebar-link">load, initialize</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#load" class="sidebar-link">load</a></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#initialize" class="sidebar-link">initialize</a></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#什么情况下使用" class="sidebar-link">什么情况下使用</a></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#总结" class="sidebar-link">总结</a></li></ul></li><li class="sidebar-sub-header"><a href="/kakadeeBlog/iOS/iOSBasic/Category本质.html#面试题" class="sidebar-link">面试题</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Core Animation</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="category本质"><a href="#category本质" aria-hidden="true" class="header-anchor">#</a> Category本质</h1> <p>苹果公司在Objective-C 2.0中，提供了category这个语言特性，可以动态地为已有类添加新行为。</p> <h2 id="category-使用场合"><a href="#category-使用场合" aria-hidden="true" class="header-anchor">#</a> Category 使用场合</h2> <h4 id="_1-为已经存在的类添加新的方法，或者覆盖原有的方法"><a href="#_1-为已经存在的类添加新的方法，或者覆盖原有的方法" aria-hidden="true" class="header-anchor">#</a> 1. 为已经存在的类添加新的方法，或者覆盖原有的方法</h4> <p>例如想扩展系统的UIButton的功能，可以为UIButton写一个Category, 这样引用 <code>UIButton+Category.h</code> 即可以使用新添加的方法了。</p> <h4 id="_2-分类"><a href="#_2-分类" aria-hidden="true" class="header-anchor">#</a> 2. 分类</h4> <p>一个类中的代码非常多，如果超过1000多行，那么在翻阅的时候也会觉得很困难，这时候可以采取分类的方式，把想通类型的代码加载在一起。这样，可以把类的实现分开在不同的几个文件里面。好处多多：</p> <ul><li>可以减少单个文件的体积</li> <li>可以把不同的功能组织到不同的category里</li> <li>可以由多个开发者共同完成一个类</li> <li>可以按需加载想要的category 等等。</li></ul> <h2 id="category-实现原理"><a href="#category-实现原理" aria-hidden="true" class="header-anchor">#</a> Category 实现原理</h2> <p>iOS 在 runtime (程序运行的时候，而不是编译的时候)动态的将 Category 中的方法添加到类方法或者元类方法中。</p> <h3 id="编译期"><a href="#编译期" aria-hidden="true" class="header-anchor">#</a> 编译期</h3> <p>在编译的时候，所有的 Category 文件都会被转化成 category_t 的结构体形式。但是并没有合并到class的底层结构中去。category_t 结构体的定义如下：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">struct</span> category_t <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> _category_t <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> _class_t <span class="token operator">*</span>cls<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> _method_list_t <span class="token operator">*</span>instance_methods<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> _method_list_t <span class="token operator">*</span>class_methods<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> _protocol_list_t <span class="token operator">*</span>protocols<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> _prop_list_t <span class="token operator">*</span>properties<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>创建一个<code>LJPerson</code> 类如下：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token comment">// 创建LJPerson类，里面不添加任何属性和方法</span>
<span class="token comment">// LJPerson.h</span>
<span class="token comment">// LJPerson.m </span>

<span class="token comment">// LJPerson+Test1.h</span>
<span class="token keyword">@interface</span> LJPerson <span class="token punctuation">(</span>Test1<span class="token punctuation">)</span>
<span class="token keyword">@property</span><span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> assign<span class="token punctuation">)</span> NSInteger age<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>eat<span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>walk<span class="token punctuation">;</span>
<span class="token keyword">@end</span>

<span class="token comment">// LJPerson+Test1.m</span>
<span class="token keyword">@implementation</span> LJPerson <span class="token punctuation">(</span>Test1<span class="token punctuation">)</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>eat <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;eat&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>walk <span class="token punctuation">{</span>
     <span class="token function">NSLog</span><span class="token punctuation">(</span><span class="token string">@&quot;walk&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>将 <code>LJPerson+Test1.m</code> 重写成cpp的代码：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code>xcrun <span class="token operator">-</span>sdk iphoneos clang <span class="token operator">-</span>arch arm64 <span class="token operator">-</span>rewrite<span class="token operator">-</span>objc LJPerson<span class="token operator">+</span>Test1<span class="token punctuation">.</span>m

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以得到核心代码如下：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token comment">/*_method_list_t*/</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> entsize<span class="token punctuation">;</span>  <span class="token comment">// sizeof(struct _objc_method)</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> method_count<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> _objc_method method_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> _OBJC_$_CATEGORY_INSTANCE_METHODS_LJPerson_$_Test1 __attribute__ <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> section <span class="token punctuation">(</span><span class="token string">&quot;__DATA,__objc_const&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token keyword">sizeof</span><span class="token punctuation">(</span>_objc_method<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token keyword">struct</span> objc_selector <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">&quot;eat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v16@0:8&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>_I_LJPerson_Test1_eat<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token comment">/*_method_list_t*/</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> entsize<span class="token punctuation">;</span>  <span class="token comment">// sizeof(struct _objc_method)</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> method_count<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> _objc_method method_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> _OBJC_$_CATEGORY_CLASS_METHODS_LJPerson_$_Test1 __attribute__ <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> section <span class="token punctuation">(</span><span class="token string">&quot;__DATA,__objc_const&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token keyword">sizeof</span><span class="token punctuation">(</span>_objc_method<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token keyword">struct</span> objc_selector <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">&quot;walk&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;v16@0:8&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>_C_LJPerson_Test1_walk<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token comment">/*_prop_list_t*/</span> <span class="token punctuation">{</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> entsize<span class="token punctuation">;</span>  <span class="token comment">// sizeof(struct _prop_t)</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> count_of_properties<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> _prop_t prop_list<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> _OBJC_$_PROP_LIST_LJPerson_$_Test1 __attribute__ <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> section <span class="token punctuation">(</span><span class="token string">&quot;__DATA,__objc_const&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token keyword">sizeof</span><span class="token punctuation">(</span>_prop_t<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token number">1</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Tq,N&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token function">__declspec</span><span class="token punctuation">(</span>dllimport<span class="token punctuation">)</span> <span class="token keyword">struct</span> _class_t OBJC_CLASS_$_LJPerson<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> _category_t _OBJC_$_CATEGORY_LJPerson_$_Test1 __attribute__ <span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> section <span class="token punctuation">(</span><span class="token string">&quot;__DATA,__objc_const&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> 
<span class="token punctuation">{</span>
	<span class="token string">&quot;LJPerson&quot;</span><span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// &amp;OBJC_CLASS_$_LJPerson,</span>
	<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> _method_list_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_OBJC_$_CATEGORY_INSTANCE_METHODS_LJPerson_$_Test1<span class="token punctuation">,</span>
	<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> _method_list_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_OBJC_$_CATEGORY_CLASS_METHODS_LJPerson_$_Test1<span class="token punctuation">,</span>
	<span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> _prop_list_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_OBJC_$_PROP_LIST_LJPerson_$_Test1<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> OBJC_CATEGORY_SETUP_$_LJPerson_$<span class="token function">_Test1</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
	_OBJC_$_CATEGORY_LJPerson_$_Test1<span class="token punctuation">.</span>cls <span class="token operator">=</span> <span class="token operator">&amp;</span>OBJC_CLASS_$_LJPerson<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">pragma</span> section(&quot;.objc_inithooks$B&quot;, long, read, write)</span>
<span class="token function">__declspec</span><span class="token punctuation">(</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token string">&quot;.objc_inithooks$B&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span>OBJC_CATEGORY_SETUP<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>OBJC_CATEGORY_SETUP_$_LJPerson_$_Test1<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> _category_t <span class="token operator">*</span>L_OBJC_LABEL_CATEGORY_$ <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> section <span class="token punctuation">(</span><span class="token string">&quot;__DATA, __objc_catlist,regular,no_dead_strip&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">=</span> <span class="token punctuation">{</span>
	<span class="token operator">&amp;</span>_OBJC_$_CATEGORY_LJPerson_$_Test1<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>我们可以看到，</p> <ol><li><p>编译器生成了实例方法列表 <code>_OBJC_$_CATEGORY_INSTANCE_METHODS_LJPerson_$_Test1</code></p></li> <li><p>编译器生成了类方法列表 <code>_OBJC_$_CATEGORY_CLASS_METHODS_LJPerson_$_Test1</code></p></li> <li><p>编译器生成了属性列表 <code>_OBJC_$_PROP_LIST_LJPerson_$_Test1</code></p></li> <li><p>编译器生成了category本身 <code>_OBJC_$_CATEGORY_LJPerson_$_Test1</code>，并用前面生成的列表来初始化category本身</p></li> <li><p>将 <code>_OBJC_$_CATEGORY_LJPerson_$_Test1</code> 的 cls 指针指向 <code>LJPerson</code>的地址<code>&amp;OBJC_CLASS_$_LJPerson</code></p></li> <li><p>最后，编译器在DATA段下的<code>__objc_catlist</code> section里保存了一个大小为 1 的 category_t 的数组 <code>L_OBJC_LABELCATEGORY$</code>（当然，如果有多个category，会生成对应长度的数组），用于运行期category的加载。</p></li></ol> <h3 id="运行期"><a href="#运行期" aria-hidden="true" class="header-anchor">#</a> 运行期</h3> <p>运行期的源码就不贴在这里了，有兴趣的可以自行百度。 Category 运行期的加载大概经历这么几个阶段：</p> <ol><li><p>通过 Runtime 加载某个类的所有 Category 数据</p></li> <li><p>把所有 Category 的方法，属性，协议数据，合并到一个大数组中，最后面参与编译的分类优先放在前面。</p></li> <li><p>将合并后的分类数据（方法，属性，协议），插入到类原来数据的前面</p></li></ol> <h2 id="category-添加成员变量"><a href="#category-添加成员变量" aria-hidden="true" class="header-anchor">#</a> Category 添加成员变量</h2> <h3 id="正确认识"><a href="#正确认识" aria-hidden="true" class="header-anchor">#</a> 正确认识</h3> <p>在一般情况下，我们能否给 Category 添加成员变量呢？</p> <p>答案自然是否否定的。原因也很简单，因为底层结构就没有存储 Category 的实例变量，只存储了方法，协议和属性。</p> <p>我们为 Category 添加属性，只会声明setter和getter方法，并不会为我们自动生成相应的实例变量。所以为 Category 里的属性赋值是没有作用的。</p> <p><strong>那么苹果为什么不存储实例变量，为什么Category要这么设计呢？</strong></p> <p>我们设想一下如果Objective-C允许动态增加成员变量，会发生什么事情。
这样做会带来严重问题，为基类动态增加成员变量会导致所有已创建出的子类实例都无法使用，比如上线后的app，如果用户手机系统升级iOS新版本后，必须重新编译提交才能在新版系统上运行。那为什么runtime允许动态添加方法和属性，而不会引发问题呢？</p> <p>因为方法和属性并不“属于”类实例，而成员变量“属于”类实例。我们所说的“类实例”概念，指的是一块内存区域，包含了isa指针和所有的成员变量。所以假如允许动态修改类成员变量布局，已经创建出的类实例就不符合类定义了，变成了无效对象。但方法定义是在objc_class中管理的，不管如何增删类方法，都不影响类实例的内存布局，已经创建出的类实例仍然可正常使用。</p> <h3 id="如何添加"><a href="#如何添加" aria-hidden="true" class="header-anchor">#</a> 如何添加</h3> <p>那么，能不能间接实现给一个 Category 添加 成员变量呢？</p> <p>答案是使用 <strong>关联对象</strong> 。</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token comment">// LJPerson+Test1.h</span>
<span class="token comment">// 在 分类中声名一个属性 name</span>
<span class="token keyword">@interface</span> LJPerson <span class="token punctuation">(</span>Test1<span class="token punctuation">)</span>
<span class="token keyword">@property</span><span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span> copy<span class="token punctuation">)</span> NSString <span class="token operator">*</span>name<span class="token punctuation">;</span>
<span class="token keyword">@end</span>

<span class="token comment">// LJPerson+Test1.m</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>kNameKey <span class="token operator">=</span> <span class="token operator">&amp;</span>kNameKey<span class="token punctuation">;</span> <span class="token comment">// 这里只需要为key设置一个唯一值就可以了</span>

<span class="token operator">-</span> <span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>name <span class="token punctuation">{</span>
    <span class="token comment">// 返回关联对象</span>
    <span class="token keyword">return</span> <span class="token function">objc_getAssociatedObject</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> kNameKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>setName<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>name <span class="token punctuation">{</span>
    <span class="token comment">// 设置关联对象</span>
    <span class="token function">objc_setAssociatedObject</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> kNameKey<span class="token punctuation">,</span> name<span class="token punctuation">,</span> OBJC_ASSOCIATION_COPY_NONATOMIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="关联对象的原理"><a href="#关联对象的原理" aria-hidden="true" class="header-anchor">#</a> 关联对象的原理</h3> <p><img src="https://raw.githubusercontent.com/kakadee/myMarkDownPic/master/img/20191021212831.png" alt="关联对象的原理"></p> <h2 id="load-initialize"><a href="#load-initialize" aria-hidden="true" class="header-anchor">#</a> load, initialize</h2> <h3 id="load"><a href="#load" aria-hidden="true" class="header-anchor">#</a> load</h3> <p>在 <a href="https://developer.apple.com/reference/objectivec/nsobject/1418815-load?language=objc" target="_blank" rel="noopener noreferrer">苹果官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中是这样描述的：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code>Invoked whenever a class or category is added to the Objective<span class="token operator">-</span>C runtime<span class="token punctuation">;</span> implement this method to perform class<span class="token operator">-</span>specific behavior upon loading<span class="token punctuation">.</span>

当类（Class）或者类别（Category）加入Runtime中时（就是被引用的时候）。
实现该方法，可以在加载时做一些类特有的操作。

Discussion

The load message is sent to classes and categories that are both dynamically loaded and statically linked<span class="token punctuation">,</span> but only <span class="token keyword">if</span> the newly loaded class or category implements a method that can respond<span class="token punctuation">.</span>

The order of initialization is as follows<span class="token punctuation">:</span>

All initializers <span class="token keyword">in</span> any framework you link to<span class="token punctuation">.</span>
调用所有的Framework中的初始化方法

All <span class="token operator">+</span>load methods <span class="token keyword">in</span> your image<span class="token punctuation">.</span>
调用所有的<span class="token operator">+</span>load方法

All C<span class="token operator">++</span> <span class="token keyword">static</span> initializers and C<span class="token operator">/</span>C<span class="token operator">++</span> <span class="token function">attribute</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span> functions <span class="token keyword">in</span> your image<span class="token punctuation">.</span>
调用C<span class="token operator">++</span>的静态初始化方及C<span class="token operator">/</span>C<span class="token operator">++</span>中的<span class="token function">attribute</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span>函数

All initializers <span class="token keyword">in</span> frameworks that link to you<span class="token punctuation">.</span>
调用所有链接到目标文件的framework中的初始化方法

In addition<span class="token punctuation">:</span>

A class’s <span class="token operator">+</span>load method is called after all of its superclasses’ <span class="token operator">+</span>load methods<span class="token punctuation">.</span>
一个类的<span class="token operator">+</span>load方法在其父类的<span class="token operator">+</span>load方法后调用

A category <span class="token operator">+</span>load method is called after the class’s own <span class="token operator">+</span>load method<span class="token punctuation">.</span>
一个Category的<span class="token operator">+</span>load方法在被其扩展的类的自有<span class="token operator">+</span>load方法后调用

In a custom implementation of load you can therefore safely message other unrelated classes from the same image<span class="token punctuation">,</span> but any load methods implemented by those classes may not have run yet<span class="token punctuation">.</span>
在<span class="token operator">+</span>load方法中，可以安全地向同一二进制包中的其它无关的类发送消息，但接收消息的类中的<span class="token operator">+</span>load方法可能尚未被调用。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><strong>load函数调用特点如下:</strong></p> <p>当类被引用进项目的时候就会执行load函数(在main函数开始执行之前）,与这个类是否被用到无关,每个类的load函数只会自动调用一次.由于load函数是系统自动加载的，因此不需要调用父类的load函数，否则父类的load函数会多次执行。</p> <ol><li>当父类和子类都实现load函数时,父类的load方法执行顺序要优先于子类</li> <li>当子类未实现load方法时,不会调用父类load方法</li> <li>类中的load方法执行顺序要优先于类别(Category)</li> <li>当有多个类别(Category)都实现了load方法,这几个load方法都会执行,但执行顺序不确定(其执行顺序与类别在Compile Sources中出现的顺序一致)</li> <li>当然当有多个不同的类的时候,每个类load 执行顺序与其在Compile Sources出现的顺序一致</li></ol> <h3 id="initialize"><a href="#initialize" aria-hidden="true" class="header-anchor">#</a> initialize</h3> <p>同样，在 <a href="https://developer.apple.com/documentation/objectivec/nsobject/1418639-initialize?language=occ" target="_blank" rel="noopener noreferrer">苹果官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中是这样描述的：</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code>Initializes the class before it receives its first message<span class="token punctuation">.</span>

在这个类接收第一条消息之前调用。

Discussion

The runtime sends initialize to each class <span class="token keyword">in</span> a program exactly one time just before the class<span class="token punctuation">,</span> or any class that inherits from it<span class="token punctuation">,</span> is sent its first message from within the program<span class="token punctuation">.</span> <span class="token punctuation">(</span>Thus the method may never be invoked <span class="token keyword">if</span> the class is not used<span class="token punctuation">.</span><span class="token punctuation">)</span> The runtime sends the initialize message to classes <span class="token keyword">in</span> a thread<span class="token operator">-</span>safe manner<span class="token punctuation">.</span> Superclasses receive this message before their subclasses<span class="token punctuation">.</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>initialize在类或者其子类的第一个方法被调用前调用。即使类文件被引用进项目,但是没有使用,initialize不会被调用。由于是系统自动调用，也不需要再调用  [super initialize] ，否则父类的initialize会被多次执行。假如这个类放到代码中，而这段代码并没有被执行，这个函数是不会被执行的。</p> <p>1.父类的initialize方法会比子类先执行<br>
2.当子类未实现initialize方法时,会调用父类initialize方法,子类实现initialize方法时,会覆盖父类initialize方法.<br>
3.当有多个Category都实现了initialize方法,会覆盖类中的方法,只执行一个(会执行Compile Sources 列表中最后一个Category 的initialize方法)</p> <h3 id="什么情况下使用"><a href="#什么情况下使用" aria-hidden="true" class="header-anchor">#</a> 什么情况下使用</h3> <h4 id="load的使用"><a href="#load的使用" aria-hidden="true" class="header-anchor">#</a> load的使用</h4> <p>由于调用load方法时的环境很不安全，我们应该尽量减少load方法的逻辑。另一个原因是load方法是线程安全的，它内部使用了锁，所以我们应该避免线程阻塞在load方法中</p> <p>load很常见的一个使用场景,交换两个方法的实现.</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token comment">//摘自MJRefresh</span>
<span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>load
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> exchangeInstanceMethod1<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>reloadData<span class="token punctuation">)</span> method2<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>mj_reloadData<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> exchangeInstanceMethod1<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>reloadRowsAtIndexPaths<span class="token punctuation">:</span>withRowAnimation<span class="token punctuation">:</span><span class="token punctuation">)</span> method2<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>mj_reloadRowsAtIndexPaths<span class="token punctuation">:</span>withRowAnimation<span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> exchangeInstanceMethod1<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>deleteRowsAtIndexPaths<span class="token punctuation">:</span>withRowAnimation<span class="token punctuation">:</span><span class="token punctuation">)</span> method2<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>mj_deleteRowsAtIndexPaths<span class="token punctuation">:</span>withRowAnimation<span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> exchangeInstanceMethod1<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>insertRowsAtIndexPaths<span class="token punctuation">:</span>withRowAnimation<span class="token punctuation">:</span><span class="token punctuation">)</span> method2<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>mj_insertRowsAtIndexPaths<span class="token punctuation">:</span>withRowAnimation<span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> exchangeInstanceMethod1<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>reloadSections<span class="token punctuation">:</span>withRowAnimation<span class="token punctuation">:</span><span class="token punctuation">)</span> method2<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>mj_reloadSections<span class="token punctuation">:</span>withRowAnimation<span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> exchangeInstanceMethod1<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>deleteSections<span class="token punctuation">:</span>withRowAnimation<span class="token punctuation">:</span><span class="token punctuation">)</span> method2<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>mj_deleteSections<span class="token punctuation">:</span>withRowAnimation<span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> exchangeInstanceMethod1<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>insertSections<span class="token punctuation">:</span>withRowAnimation<span class="token punctuation">:</span><span class="token punctuation">)</span> method2<span class="token punctuation">:</span><span class="token keyword">@selector</span><span class="token punctuation">(</span>mj_insertSections<span class="token punctuation">:</span>withRowAnimation<span class="token punctuation">:</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>exchangeInstanceMethod1<span class="token punctuation">:</span><span class="token punctuation">(</span>SEL<span class="token punctuation">)</span>method1 method2<span class="token punctuation">:</span><span class="token punctuation">(</span>SEL<span class="token punctuation">)</span>method2
<span class="token punctuation">{</span>
    <span class="token function">method_exchangeImplementations</span><span class="token punctuation">(</span><span class="token function">class_getInstanceMethod</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> method1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">class_getInstanceMethod</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">,</span> method2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="initialize的使用"><a href="#initialize的使用" aria-hidden="true" class="header-anchor">#</a> initialize的使用</h4> <p>一般用来初始化全局变量或者静态变量。在initialize方法收到调用时,运行环境基本健全。 initialize内部也使用了锁，所以是线程安全的。但同时要避免阻塞线程，不要再使用锁。</p> <div class="language-objectivec line-numbers-mode"><pre class="language-objectivec"><code><span class="token comment">// Person.m</span>
<span class="token comment">// int 等基本类型可以在编译期进行赋值</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> numCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 对象无法在编译器进行赋值</span>
<span class="token keyword">static</span> NSMutableArray <span class="token operator">*</span>dataSource<span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>initialize <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">self</span> <span class="token operator">==</span> <span class="token punctuation">[</span>Person class<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不能在编译期赋值的对象在这里进行赋值 dataSource = [[NSMutableArray alloc] init];</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="总结"><a href="#总结" aria-hidden="true" class="header-anchor">#</a> 总结</h3> <ul><li><p>正常情况下(即没有在 load 方法中调用相关类方法)，load 和 Initialize 方法都在实例化对象之前调用，load相当于装载方法，都在main()函数之前调用，Initialize方法都在main() 函数之后调用。</p></li> <li><p>如果在A类的 load 方法中调用 B 类的类方法，那么在调用A的Load 方法之前，会先调用一下B类的initialize 方法，但是B类的load 方法还是按照 Compile Source 顺序进行加载</p></li> <li><p>如果A类的 load 方法中调用 A类的类方法， 那么 Initialize 在 load 方法之前调用, 且都在main 函数之前。</p></li> <li><p>所有类的 load 方法都会被调用，先调用父类、再调用子类，多个分类会按照Compile Sources 顺序加载。但是Initialize 方法会被覆盖，子类父类分类中只会执行一个</p></li> <li><p>load 方法内部一般用来实现 Method Swizzle，Initialize方法一般用来初始化全局变量或者静态变量
两个方法都不能主动调用，也不需要通过 super 继承父类方法，但是 Initialize 方法会在子类没有实现的时候调用父类的该方法，而 load 不会</p></li></ul> <h2 id="面试题"><a href="#面试题" aria-hidden="true" class="header-anchor">#</a> 面试题</h2> <h4 id="_1-category-的使用场合是什么"><a href="#_1-category-的使用场合是什么" aria-hidden="true" class="header-anchor">#</a> 1. Category 的使用场合是什么</h4> <h4 id="_2-category的实现原理，以及category为什么只能加方法不能加属性"><a href="#_2-category的实现原理，以及category为什么只能加方法不能加属性" aria-hidden="true" class="header-anchor">#</a> 2. Category的实现原理，以及Category为什么只能加方法不能加属性</h4> <h4 id="_3-category-和-extension-的区别"><a href="#_3-category-和-extension-的区别" aria-hidden="true" class="header-anchor">#</a> 3. Category 和 Extension 的区别</h4> <p>Extension 在编译的时候，它的数据就已经包含在类信息中<br>
Category在运行时，才会将数据合并到类信息中</p> <h4 id="_4-category中有load方法吗？load方法是什么时候调用的？load-方法能继承吗？"><a href="#_4-category中有load方法吗？load方法是什么时候调用的？load-方法能继承吗？" aria-hidden="true" class="header-anchor">#</a> 4. Category中有load方法吗？load方法是什么时候调用的？load 方法能继承吗？</h4> <p>有。load 方法在runtime加载类和分类的时候调用。不需要声名声名和创建实例，也不需要引入头文件，只要程序运行，就会加载load 方法。类和分类的load方法都会调用，因为不是通过objcMsgSend方式调用的，是直接通过指针调用的。</p> <h4 id="_5-load、initialize的区别，以及它们在category重写的时候的调用的次序。"><a href="#_5-load、initialize的区别，以及它们在category重写的时候的调用的次序。" aria-hidden="true" class="header-anchor">#</a> 5. load、initialize的区别，以及它们在category重写的时候的调用的次序。</h4> <h4 id="_6-category-能否添加成员变量？-如果可以，如何给category添加成员变量"><a href="#_6-category-能否添加成员变量？-如果可以，如何给category添加成员变量" aria-hidden="true" class="header-anchor">#</a> 6. Category 能否添加成员变量？ 如果可以，如何给Category添加成员变量</h4> <p>Category不能直接添加成员变量。但是可以间接添加。使用关联对象。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间: </span> <span class="time">11/12/2019, 2:55:06 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/kakadeeBlog/iOS/iOSBasic/DesignatedInitializer.html" class="prev">
          Designated initializer
        </a></span> <span class="next"><a href="/kakadeeBlog/iOS/CoreAnimation/CoreAnimation路径规划.html">
          Core Animation路径规划
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/kakadeeBlog/assets/js/app.8bc012c0.js" defer></script><script src="/kakadeeBlog/assets/js/2.312bb894.js" defer></script><script src="/kakadeeBlog/assets/js/13.3fa76b06.js" defer></script>
  </body>
</html>
